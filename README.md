
- 4 **Интерфейсы программных компонентов**
    
    Каждый объект в системе должен предоставить свой интерфейс в MQTT брокере. Интерфейс состоит из набора топиков через которые объект публикует своё состояние и набора подписок, через которые он управляется. Все данные передаваемые через MQTT организованы ввиде JSON структур.
    
    1. Общие для всех объектов свойства
        
        `ID` — уникальный идентификатор объекта в формате GUID (пример: 2c98eeb2-9710-4292-9999-41239673bd12);
        
        `Type` — тип объекта;
        
        `Name` — имя объекта для отображения в понятном человеку виде.
        
        1. Каждый топик объекта должен начинаться c `ID`.
        2. Каждый объект должен иметь топик вида: `/{ID}/desс` c описанием общих полей объекта (как минимум `Type` и `Name`).
        
        Топик (публикация): `/{ID}/desc`
        
        Структура:
        
        ```jsx
        {
        "type": "button",
        "name": "Кнопка в холле"
        }
        ```
        
    2. Типы объектов и их интерфейсы
        1. Кнопка (`type: button`). Для виртуальных (на [СП](https://www.notion.so/6d6fd6a7a9954f388eb998c3d3ed3f9c)) и физических (на [КП](https://www.notion.so/6d6fd6a7a9954f388eb998c3d3ed3f9c)) принимается единый интерфейс.
            
            Топик (публикация): `/{ID}/state` используется для публикации состояния кнопки по событиям «нажатие», «долгое нажатие», «двойное нажатие», «отпускание».
            
            Структура:
            
            ```jsx
            {
            "event": "<event_type>",
            "dev_id": "<device_guid>"
            }
            ```
            
            `event` — `press`, `long_press`, `double_press`, `release`.
            
            `dev_id` — идентификатор устройства, на котором находится объект в формате GUID.
            
            Топик (подписка): `/{ID}/control` используется для управления состоянием кнопки.
            
            Структура:
            
            ```jsx
            {
            "back_light": 0x000000,
            "enabled": true
            }
            ```
            
            `back_light` — цвет подсветки кнопки, задается в формате 0xRRGGBB.
            
            `enabled` — состояние «активно», если выставлено в `true` компоненту разрешено взаимодействие с пользователем (применяется только к виртуальным кнопкам на СП).
            
            ***Должен быть указан как минимум один параметр.***
            
        2. Фейдер (`type: fader`).
            
            Топик (публикация): `/{ID}/state` используется для публикации состояния фейдера по событию изменения значения.
            
            Структура:
            
            ```jsx
            {
            "value": 0.0
            }
            ```
            
            `value` — содержит текущее значение фейдера (0.0 — 1.0, где 0.0 — 0%, 1.0 — 100%).
            
            Топик (подписка): `/{ID}/control` используется для управления состоянием фейдера.
            
            Структура:
            
            ```jsx
            {
            "value": 0.0,
            "enabled": true
            }
            ```
            
            `value` — содержит устанавливаемое значение фейдера (0.0 — 1.0, где 0.0 — 0%, 1.0 — 100%).
            
            `enabled` — состояние «активно», если выставлено в `true` компоненту разрешено взаимодействие с пользователем.
            
            ***Должен быть указан как минимум один параметр.***
            
        3. Канал (`type: channel`).
            
            Топик (публикация): `/{ID}/state` используется для публикации состояния канала.
            
            Структура:
            
            ```jsx
            {
            "value": 0.0
            }
            ```
            
            `value` — содержит текущее значение канала (0.0 — 1.0, где 0.0 — 0%, 1.0 — 100%).
            
            Топик (подписка): `/{ID}/control` используется для управления состоянием канала.
            
            Структура:
            
            ```jsx
            {
            "value": 0.0
            }
            ```
            
            `value` — содержит устанавливаемое значение канала (0.0 — 1.0, где 0.0 — 0%, 1.0 — 100%).
            
            Топик (подписка): `/{ID}/config` используется для конфигурации канала.
            
            Структура:
            
            ```jsx
            {
            "raise_time": 0.0,
            "fall_time": 0.0,
            "sacn_universe": 1,
            "sacn_priority": 100,
            "sacn_name": "APOLLO",
            "sacn_pps": 0
            }
            ```
            
            `raise_time` — время (сек) плавного увеличения мощности в канале (изменение от текущего значения до установленного, если установленное больше текущего).
            
            `fall_time` — время (сек) плавного снижения мощности в канале (изменение от текущего значения до установленного, если установленное меньше текущего).
            
            `sacn_universe` — sACN юниверс (1 - 63999).
            
            `sacn_priority` — sACN приоритет потока (0 - 200), по умолчанию 100.
            
            `sacn_name` — sACN имя источника.
            
            `sacn_pps` — sACN количество пакетов в секунду (0 - 40), 0 - динамически.
            
            ***Должен быть указан как минимум один параметр.***
            
        4. Сенсорная панель «[ГИП](https://www.notion.so/6d6fd6a7a9954f388eb998c3d3ed3f9c)» (`type: panel`)
            
            Топик (публикация): `/{ID}/state` используется для публикации состояния СП.
            
            Структура:
            
            ```jsx
            {
            "locked": false,
            "page": "<page_guid>"
            }
            ```
            
            `locked` — если `true`, панель заблокирована и на ней отображается экран блокировки.
            
            `page` — текущая отображаемая страница на экране СП.
            
            Топик (подписка): `/{ID}/control` используется для управления СП.
            
            Структура:
            
            ```jsx
            {
            "lock": false,
            "screen_off": false,
            "set_page": "<page_guid>"
            }
            ```
            
            `lock` — если устанавливается в `true`, СП блокируется и начинает отображать экран блокировки.
            
            `screen_off` — если устанавливается в `true`, экран СП гасится принудительно.
            
            `set_page` — установка текущей страницы для отображения на СП.
            
            ***Должен быть указан как минимум один параметр.***
            
        5. Страница (`type: page`). Специальный объект не имеющий интерфейса в MQTT брокере. Представляет собой конфигурацию одного экрана СП (расположение и размеры кнопок, фейдеров, настройки бэкграунда и т.д.) в формате JSON. Данный объект отдается Core по запросу СП. Страница кэшируется на стороне СП и больше незапрашивается у Core до перезагрузки системы. Тем не менее Core решает, какая страница отображается в данный момент на СП задавая её по `page_guid`.
- 5 **Core**
    
    Представляет собой связующий компонент между всеми остальными компонентами системы. Занимается обработкой всех событий передающихся через MQTT (version 5) и принимает решение о выдаче управляющих сигналов на [ЦОУ](https://www.notion.so/6d6fd6a7a9954f388eb998c3d3ed3f9c). Так же в задачу Core входит выдача страниц на СП и обеспечение логики переходов между ними при получении событий от кнопок.
    
    Те или иные решения принимаются Core на основе конфигурации предварительно составленной в конфигураторе системы.
    
    1. Запрос и переключение страниц СП.
        
        При включении системы по мере обнаружения СП, Core должен опубликовать в `control` топик каждой СП идентификатор соответствующий ей главной странице, после чего СП запросит у Core конфигурацию данной страницы.
        
        При нажатии на кнопку, действием которой является переход на другую страницу Core должен опубликовать в `control` топик данной СП идетнификатор требуемой страницы, после чего СП запросит у Core конфигурацию данной страницы и отобразит на экране.
        
        При нажатии на специальную кнопку «Назад», Core должен опубликовать в `control` топик СП идентификатор предыдущей страницы.
        
        Определение с какой СП была нажата кнопка осуществляется по полю `dev_id` (топик `state` кнопки).
        
    2. Выдача управляющего	сигнала на ЦОУ.
        
        При получении события от кнопки или фейдера Core должен выдать соответствующее событие в канал управления привязанный к данной кнопке или фейдеру.
        
    3. Группировка каналов.
        
        Каналы могут быть помещены в группу и тем самым сформировать объект «виртуальный канал». Его интерфейс идентичен обычному каналу (настройки sACN игнорируются). Далее работа с этим каналом происходит аналогично обычному физическому каналу, при этом управляющее воздействие рассылается на все каналы в группе. Виртуальные каналы регистрируется в MQTT при загрузке конфигурации Core.
        
    4. Работа по расписанию
        
        В Core должен быть реализован функционал работы по расписанию (выдача событий в заданный день, время).
        
    5. Предполагаемый стек технологий:
        1. ЯП - [Python](http://www.python.org) 3.9.5
        2. mqtt-клиент - [paho-mqtt](https://pypi.org/project/paho-mqtt/) 1.6.1